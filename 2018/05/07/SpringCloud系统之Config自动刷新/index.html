<!DOCTYPE html><html lang="en"><head><link rel="manifest" href="/manifest.json"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="胡萝虎的个人博客"><meta name="keywords" content="Config,RabbitMQ,自动刷新,Spring Cloud,胡萝虎,coding,github,"><meta name="theme-color" content="#600090"><meta name="msapplication-navbutton-color" content="#600090"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#600090"><meta name="google-site-verification" content="Fopvra9wVSD0vPGoK0_S3WC-WOIXGozNTIGw9u9fUwE"><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" title="胡萝虎" href="/atom.xml"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css"><link rel="apple-touch-icon" href="/img/touch/avatar_220.jpeg"><link rel="apple-touch-icon" href="/img/touch/avatar_220.jpeg"><title>SpringCloud系列之Config自动刷新｜胡萝虎的博客</title><link rel="canonical" href="https://huluohu.com/2018/05/07/SpringCloud系统之Config自动刷新/"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/blog-style.css"><link rel="stylesheet" href="/css/syntax.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css"><meta name="generator" content="Hexo 5.3.0"></head><style>header.intro-header{background-image:url(/img/avatarbg.jpg)}</style><body ontouchstart="" class="animated fadeIn"><nav class="navbar navbar-default navbar-custom navbar-fixed-top" id="nav-top" data-ispost="true" data-istags="false
" data-ishome="false"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand animated pulse" href="/"><span class="brand-logo">胡萝虎 </span>Blog</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/archive/">archive</a></li><li><a href="/tags/">tags</a></li><li><a href="/about">About</a></li></ul></div></div></div></nav><script>var $toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><img class="wechat-title-img" src="undefinedconfigrefresh01.jpg"><style>header.intro-header{background-image:url(undefinedconfigrefresh01.jpg?imageView2/1/w/1400/h/400/interlace/1/q/90)}</style><header class="intro-header"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center"><div class="post-heading"><h1>SpringCloud系列之Config自动刷新</h1><span class="meta">作者 胡萝虎 <span>日期 2018-05-07</span></span><div class="tags text-center"><a class="tag" href="/tags/#Spring Cloud" title="Spring Cloud">Spring Cloud</a> <a class="tag" href="/tags/#Spring Boot" title="Spring Boot">Spring Boot</a> <a class="tag" href="/tags/#Spring" title="Spring">Spring</a> <a class="tag" href="/tags/#微服务" title="微服务">微服务</a> <a class="tag" href="/tags/#Config" title="Config">Config</a> <a class="tag" href="/tags/#Bus" title="Bus">Bus</a> <a class="tag" href="/tags/#rabbitmq" title="rabbitmq">rabbitmq</a></div></div></div></div></div><div class="post-title-haojen"><span>SpringCloud系列之Config自动刷新</span></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container"><blockquote><p>在上一篇<a href="https://huluohu.com/2018/04/28/1524898800/">SpringCloud系列之Config</a>中，我们介绍了如何使用Spring Cloud Config来搭建一套配置管理系统。通过Spring Cloud Config的Server和Client组件，可以完成配置的管理、获取和刷新。在处理配置刷新时，需要先修改配置，然后再手工发送POST请求到Client端的刷新端点上，这种方式虽然可以实现不停机变更配置的目的，但是在微服务架构下的生产环境中却并不优雅。</p><p>当生产环境中部署了大量应用时，如果还是通过人工的方式，一台台的去刷新显然不太合理。没有人愿意做这种费力又容易出错的事情！那么，在Spring Cloud Config下如何实现自动刷新配置呢？答案是<code>Spring Cloud Bus</code>。</p></blockquote><h2 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h2><p>Spring Cloud Bus 是Spring Cloud对事件、消息总线的封装，它将分布式系统中的各个节点使用轻量级的消息代理连接起来，用于在集群（例如，配置变化事件）中传播状态变化，可与Spring Cloud Config联合实现热部署。</p><p>Spring Cloud Bus需要利用MQ进行事件、消息的传播与处理，目前常用的是RabbitMQ和Kafka，本文中涉及的MQ为RabbitMQ。所以，在开始之前，读者需要先安装RabbitMQ，由于不是本文的重点，在此不多赘述。</p><h2 id="自动刷新原理"><a href="#自动刷新原理" class="headerlink" title="自动刷新原理"></a>自动刷新原理</h2><p><img src="/images/loading.gif" data-original="https://tva1.sinaimg.cn/large/006tKfTcgy1fr2yhrkgpvj31700w40wl.jpg" alt="image-20180507164059085"></p><p>使用Spring Cloud Bus完成配置自动刷新的大致流程如下：</p><ol><li>修改并PUSH配置，触发web hook，POST请求到Config Server的 bus/refresh端点</li><li>Config Server向MQ发送配置变更消息</li><li>Client集群中的实例订阅并接收到MQ投递的消息</li><li>Client集群中的实例消费消息，从Config Server获取新配置，并刷新本地配置</li></ol><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h4 id="准备RabbitMQ"><a href="#准备RabbitMQ" class="headerlink" title="准备RabbitMQ"></a>准备RabbitMQ</h4><p>建议读者使用Docker进行安装，方便快捷，此处不深入介绍。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d --name rabbitmq -p 4369:4369 -p 5671:5671 -p 15672:15671 -p 16572:15672 rabbitmq:3-management </span><br></pre></td></tr></table></figure><h4 id="配置Config-Server"><a href="#配置Config-Server" class="headerlink" title="配置Config Server"></a>配置Config Server</h4><p>Config Server不需要做太多修改，仅需要增加必要的依赖和配置即可。</p><p>pom.xml增加依赖：</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>application.yml增加RabbitMQ和security配置:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">rabbitmq.huluohu.com</span> <span class="comment">#rabbitmq的地址（IP、域名、host等）</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">32602</span> <span class="comment">#端口</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span>	<span class="comment">#用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span>	<span class="comment">#密码</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment">#需要设置为false</span></span><br></pre></td></tr></table></figure><h4 id="配置Client应用"><a href="#配置Client应用" class="headerlink" title="配置Client应用"></a>配置Client应用</h4><p>与Config Server类似，进行添加必要的依赖和配置。</p><p>pom.xml增加依赖</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>application.yml增加RabbitMQ和security配置:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">rabbitmq.huluohu.com</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">32602</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h4 id="配置webhook"><a href="#配置webhook" class="headerlink" title="配置webhook"></a>配置webhook</h4><p>github和gitlab都支持webhook，这里我使用的是gitlab。如果读者手头没有webhook环境，也可以使用Postman工具模拟。</p><p><img src="/images/loading.gif" data-original="https://tva1.sinaimg.cn/large/006tKfTcgy1fr2yhnycoij31kw0hiq9f.jpg" alt="image-20180507180948522"></p><p>⚠️10.242.14.174是我的机器IP，这里设置的是Config Server端端点，在gitlab中需要进行一点设置才可以访问局域网IP。</p><ul><li>使用root账户登录</li><li>点击Admin area—&gt;Settings，在 Outbound requests下将<code>Allow request to the local network from hooks and services</code>勾选</li></ul><p><img src="/images/loading.gif" data-original="https://tva1.sinaimg.cn/large/006tKfTcgy1fr2yhpleh3j31kw08dgnq.jpg" alt="image-20180507181230600"></p><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><ul><li><p>启动Config Server应用</p></li><li><p>启动Config Client应用（config-example以local profile启动)</p></li><li><p>修改spring-cloud-config-repo下config-example目录中的application-local.properties文件，修改完push到git仓库</p></li><li><p>浏览器中访问<code>http://localhost:8088/test/config</code>，可以看到配置已变更。</p></li></ul><div style="width:100%;height:30px;line-height:30px;text-align:center;background:#f5f5f5"><span>没有更多了^ - ^</span></div><div style="width:100%;height:340px;text-align:center"></div><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAAAAAAYplnuAAADB0lEQVR42u2dy24bQQwE9f8/nVyCQJCG7OqRgxxUuhjWY7dmYe6Q3S348Vgev54e6bnT66fHdPzn11/fVz2EFjp8+AT3+voGfXp/Ovbp+G+LFlroAP36Nz4V2ASWFjOdK0GPnxVa6A+gE8T2PFn46QIJLfS/hN4KZmuIphNOCxFa6J+ETs34VlBtkaWm6OMuT+ivh07F879+Xk/jQn81NBVXJqGFijxpwyEb199jCi10YKIn/wllsx2WxwsltNAD9NYU0Rs/HWDpcBxFdqGFhvWTAIkAkwScNNgS4UhooTcmYtakJieJh9tCsTiTNhehhR4Em+amn0QaKj4mM3UsbqGFDtCt8Uk+R4z8FGAZjVOhhQ7QbaNPxHYyXGwXYFuw0EKfoEnD35pEVLCkZr7QQrfQNwI62TioSZ8WfxTUhRZ6gSYhqxRAaQq0GTaO5xVa6OBFpgaFNv2kKaIFi90toYUGWh4NYaWNIonm7QY1BgqFFnqAboJYVcDvwb68RopTaKEpNG2AiGhJABuRE20+Qgv95I2TwGoSJWnAJQrlRKgXWuhd18OmJJkpkYJfzKZotxNaaDI0hp2IDAXElL8NiAstdJoNk7nZmPgJbBMbty8vjOqS0EIP0Dfm+42JSc2nscESWugFmgZFqOidmrAtNPCRYiq00IcvmzUB12QikSKjZtTobAktdIBOxdE08cQgSgJOTCEILfQy0NJwLAn7kYU3IfE3DqGFZvMnAtjMT/I8EeRTsFFooTdoYrC3Rs+NEE8HZ6GFBvfvx9YwkQXRoMmNqI43F6GFPjRMJPSaGqObBooOB28pBKGFDr1HY0jSoZcKlemiCC00hW6MTxJOaQIwN4K60EIn6OYgqbEhAVkqQK6FLbTQ/L4fhUeyAbUhgeY9VcBQ6K+Fbpr5RlTZQgG3F+SRuiqhhX70/4SGmvhNU5/uCmOgUGihL6CbgGBTeCk8uC5IaKE/gG7M92QitUU9bkRCCx2gU9CqEVZuF04XLLTQCZr22WSgpRsMvSjUXBVa6D+//wYVgraVABHyAwAAAABJRU5ErkJggg=="><div style="width:100%;text-align:center"><span style="font-size:20px">“扫一扫接着看”</span></div><ul class="pager"><li class="previous"><a href="/2018/05/11/SpringCloud系列之Ribbon/" data-toggle="tooltip" data-placement="top" title="SpringCloud系列之Ribbon">&larr; Previous Post</a></li><li class="next"><a href="/2018/04/28/SpringCloud系统之Config/" data-toggle="tooltip" data-placement="top" title="SpringCloud系列之Config">Next Post &rarr;</a></li></ul><div id="lv-container" data-id="city" data-uid="MTAyMC8zNTY2My8xMjE5OQ=="><script type="text/javascript">!function(e,t){var n=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((t=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",t.async=!0,n.parentNode.insertBefore(t,n))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></div><div class="hidden-xs col-sm-3 toc-col"><div class="toc-wrap"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud-Bus"><span class="toc-text">Spring Cloud Bus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0%E5%8E%9F%E7%90%86"><span class="toc-text">自动刷新原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87RabbitMQ"><span class="toc-text">准备RabbitMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEConfig-Server"><span class="toc-text">配置Config Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEClient%E5%BA%94%E7%94%A8"><span class="toc-text">配置Client应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEwebhook"><span class="toc-text">配置webhook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li></ol></li></ol></div></div></div><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><div style="margin-top:20px"><h5 class="text-center">FRIENDS</h5><ul class="list-inline text-center"><li><a target="_blank" rel="noopener" href="https://springcloud.cc/">Spring Cloud中文网</a></li><li><a target="_blank" rel="noopener" href="http://www.spring4all.com/">Spring For All</a></li><li><a target="_blank" rel="noopener" href="https://github.com/spring-cloud">Spring Cloud</a></li></ul></div></div></div></div></article><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center"><br><ul class="list-inline text-center"><li><a target="_blank" href="https://www.zhihu.com/people/huluohu"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-stack-1x fa-inverse">知</i></span></a></li><li><a target="_blank" href="https://github.com/fooololo"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 胡萝虎 2021 浙ICP备18019084号-1<br><span id="busuanzi_container_site_pv" style="font-size:12px">访问: <span id="busuanzi_value_site_pv"></span> 次</span> <span class="post-meta-divider">|</span> <span id="busuanzi_container_site_uv" style="font-size:12px;display:none">访客：<span id="busuanzi_value_site_uv"></span>人</span><br></p></div></div></div></footer><script src="/js/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/blog.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),a=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),a.parentNode.insertBefore(r,a)}</script><script>0!==$("#tag_cloud").length&&async("https://huluohu.com/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _baId="a56cc9c749e8c4177e393ae19735216f",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?"+_baId;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript">!function(t,e,n,s,c,i){t.SwiftypeObject=s,t[s]=t[s]||function(){(t[s].q=t[s].q||[]).push(arguments)},c=e.createElement(n),i=e.getElementsByTagName(n)[0],c.async=1,c.src="//s.swiftypecdn.com/install/v2/st.js",i.parentNode.insertBefore(c,i)}(window,document,"script","_st"),_st("install","","2.0.0")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><img class="wechat-title-img" src="/img/avatar.png"><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js?t=1610684148379").then(function(){console.log("ServiceWorker Register Successfully.")}).catch(function(e){console.error(e)})</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=i;var e=n.imageLazyLoadSetting.isSPA,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight||document.documentElement.clientHeight)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},n.src=i}()}i(),n.addEventListener("scroll",function(){var t,e;t=i,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>